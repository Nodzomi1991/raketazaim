<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Ракета Telegram</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
html,body{margin:0;padding:0;overflow:hidden;font-family:sans-serif;}
#game-container{position:relative;width:100vw;height:100vh;}
canvas{display:block;}
#leaderboard{
    position:absolute;top:10px;left:10px;background:rgba(255,255,255,0.9);
    padding:10px;border-radius:5px;max-width:250px;
}
#play-btn{
    position:absolute;bottom:20px;left:50%;transform:translateX(-50%);
    padding:10px 20px;font-size:16px;
}
table{width:100%;border-collapse:collapse;}
th,td{padding:5px;border:1px solid #ccc;}
th{background:#eee;}
</style>
</head>
<body>
<div id="game-container">
    <canvas id="gameCanvas"></canvas>
    <div id="leaderboard">
        <h3>Турнирная таблица</h3>
        <table id="lb-table">
            <thead><tr><th>Игрок</th><th>Очки</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>
    <button id="play-btn">Сыграть</button>
</div>

<script>
if(typeof window.Telegram==='undefined'||!window.Telegram.WebApp){
    document.body.innerHTML="<h2>Эта игра работает только внутри мини-приложения Telegram.</h2>";
    throw new Error("Не в Telegram WebApp");
}

const tg = window.Telegram.WebApp;
tg.ready();
tg.expand();

const canvas=document.getElementById("gameCanvas");
const ctx=canvas.getContext("2d");
canvas.width=window.innerWidth;
canvas.height=window.innerHeight;

// --- Картинки ---
let rocketImg=new Image(); rocketImg.src='rocket.png';
let meteorImg=new Image(); meteorImg.src='meteor.png';
let starImg=new Image(); starImg.src='stars.png';
let bgImg=new Image(); bgImg.src='background.png';

// --- Игровые объекты ---
let rocket={x:canvas.width/2,y:canvas.height-150,width:60,height:100,angle:0};
let stars=[],meteors=[],particles=[];
let starSpawnInterval,meteorSpawnInterval;
let keys={},score=0,gameRunning=false;
let bgY=0,rocketBounce=0;

// --- Турнирная таблица ---
let leaderboard=[];
async function fetchLeaderboard(){
    try{
        const res=await fetch('/leaderboard');
        leaderboard=await res.json();
        renderLeaderboard();
    }catch(e){console.error(e);}
}
function renderLeaderboard(){
    const tbody=document.querySelector("#lb-table tbody");
    tbody.innerHTML="";
    leaderboard.sort((a,b)=>b.score-a.score);
    leaderboard.forEach(p=>{
        const tr=document.createElement("tr");
        tr.innerHTML=`<td>${p.name}</td><td>${p.score}</td>`;
        tbody.appendChild(tr);
    });
}
fetchLeaderboard();

// --- Управление ---
window.addEventListener("keydown",e=>keys[e.key]=true);
window.addEventListener("keyup",e=>keys[e.key]=false);

// --- Коллизии ---
function checkCollision(a,b){
    return !(a.x>a.x+b.width||a.x+a.width<b.x||a.y>a.y+b.height||a.y+a.height<b.y);
}

// --- Частицы огня/дыма ---
function createParticles(){
    let intensity=keys['ArrowLeft']||keys['a']||keys['ArrowRight']||keys['d']?5:3;
    for(let i=0;i<intensity;i++){
        particles.push({
            x:rocket.x+rocket.width/2+(Math.random()-0.5)*15,
            y:rocket.y+rocket.height,
            size:Math.random()*6+4,
            speedX:(Math.random()-0.5)*2,
            speedY:Math.random()*2+2,
            alpha:1,
            color:Math.random()<0.5?"orange":"yellow"
        });
    }
}
function updateParticles(){
    particles.forEach(p=>{p.x+=p.speedX;p.y+=p.speedY;p.alpha-=0.02;});
    particles=particles.filter(p=>p.alpha>0);
}
function drawParticles(){
    particles.forEach(p=>{
        ctx.globalAlpha=p.alpha;
        ctx.fillStyle=p.color;
        ctx.beginPath();
        ctx.arc(p.x,p.y,p.size,0,Math.PI*2);
        ctx.fill();
        ctx.globalAlpha=1;
    });
}

// --- Объекты ---
function spawnStar(){stars.push({x:Math.random()*(canvas.width-50),y:-50,width:40,height:40});}
function spawnMeteor(){meteors.push({x:Math.random()*(canvas.width-80),y:-80,width:80,height:80});}
function resetGame(){stars=[];meteors=[];score=0;rocket.x=canvas.width/2;rocket.y=canvas.height-150;rocket.angle=0;}

// --- Обновление ---
function update(){
    if(!gameRunning) return;

    bgY+=2; if(bgY>=canvas.height) bgY=0;

    let speed=7;
    if(keys['ArrowLeft']||keys['a']) rocket.x-=speed;
    if(keys['ArrowRight']||keys['d']) rocket.x+=speed;

    rocket.angle=keys['ArrowLeft']||keys['a']?rocket.angle+(-0.3-rocket.angle)*0.1:
                 keys['ArrowRight']||keys['d']?rocket.angle+(0.3-rocket.angle)*0.1:
                 rocket.angle+(0-rocket.angle)*0.1;

    rocketBounce=Math.sin(Date.now()/100)*0.5;

    if(rocket.x<0) rocket.x=0;
    if(rocket.x>canvas.width-rocket.width) rocket.x=canvas.width-rocket.width;

    stars.forEach(s=>s.y+=4);
    meteors.forEach(m=>m.y+=6);

    for(let i=stars.length-1;i>=0;i--){
        if(!(rocket.x>stars[i].x+stars[i].width||rocket.x+rocket.width<stars[i].x||rocket.y>stars[i].y+stars[i].height||rocket.y+rocket.height<stars[i].y)){
            score++; stars.splice(i,1);
        } else if(stars[i].y>canvas.height) stars.splice(i,1);
    }
    for(let i=meteors.length-1;i>=0;i--){
        if(!(rocket.x>meteors[i].x+meteors[i].width||rocket.x+rocket.width<meteors[i].x||rocket.y>meteors[i].y+meteors[i].height||rocket.y+rocket.height<meteors[i].y)){
            endGame(); return;
        } else if(meteors[i].y>canvas.height) meteors.splice(i,1);
    }

    createParticles();
    updateParticles();
}

// --- Рисование ---
function draw(){
    if(!gameRunning) return;

    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.drawImage(bgImg,0,bgY-canvas.height,canvas.width,canvas.height);
    ctx.drawImage(bgImg,0,bgY,canvas.width,canvas.height);

    stars.forEach(s=>ctx.drawImage(starImg,s.x,s.y,s.width,s.height));
    meteors.forEach(m=>ctx.drawImage(meteorImg,m.x,m.y,m.width,m.height));
    drawParticles();

    ctx.save();
    ctx.translate(rocket.x+rocket.width/2,rocket.y+rocket.height/2+rocketBounce);
    ctx.rotate(rocket.angle);
    ctx.drawImage(rocketImg,-rocket.width/2,-rocket.height/2,rocket.width,rocket.height);
    ctx.restore();

    ctx.fillStyle="white";
    ctx.font="24px sans-serif";
    ctx.fillText("Очки: "+score,10,30);
}

// --- Игровой цикл ---
function gameLoop(){update();draw(); if(gameRunning) requestAnimationFrame(gameLoop);}

// --- Старт/конец игры ---
async function startGame(){
    if(localStorage.getItem("playedToday")){
        const lastPlay=new Date(localStorage.getItem("playedToday"));
        const now=new Date();
        if(lastPlay.toDateString()===now.toDateString()){
            alert("Вы уже играли сегодня!");
            return;
        }
    }

    resetGame();
    gameRunning=true;
    starSpawnInterval=setInterval(spawnStar,800);
    meteorSpawnInterval=setInterval(spawnMeteor,1500);
    gameLoop();
}

async function endGame(){
    gameRunning=false;
    clearInterval(starSpawnInterval);
    clearInterval(meteorSpawnInterval);
    alert("Игра окончена! Очки: "+score);
    localStorage.setItem("playedToday",new Date());

    const playerName=tg.initDataUnsafe.user?.first_name||"Игрок";

    try{
        await fetch('/leaderboard',{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({name:playerName,score})
        });
        const res=await fetch('/leaderboard');
        leaderboard=await res.json();
        renderLeaderboard();
    }catch(e){console.error(e);}
}

// --- Кнопка старта ---
document.getElementById("play-btn").addEventListener("click",startGame);

</script>
</body>
</html>
