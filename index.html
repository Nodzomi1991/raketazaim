<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Rocket Game</title>
<style>
body { margin:0; overflow:hidden; background:black; }
#gameCanvas { display:block; margin:auto; }
#score { position:absolute; top:20px; left:20px; color:white; font-size:20px; }
</style>
</head>
<body>
<canvas id="gameCanvas" width="400" height="600"></canvas>
<div id="score">Очки: 0</div>

<script>
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
const scoreElement = document.getElementById("score");

const tg = window.Telegram.WebApp;
tg.ready();

let rocket = { x: 180, y: 500, width: 40, height: 60 };
let stars = [], meteors = [], score = 0, gameOver = false;

// Простейшая генерация объектов
function spawnObject() {
    const x = Math.random() * (canvas.width - 30);
    if (Math.random() > 0.5) stars.push({x, y:0, size:20+Math.random()*20});
    else meteors.push({x, y:0, size:20+Math.random()*20, speed:3+Math.random()*3});
}

// Обновление и проверка столкновений
function update() {
    if (gameOver) return;

    // Звёзды
    for (let i=stars.length-1;i>=0;i--){
        stars[i].y += 4;
        if (stars[i].x < rocket.x + rocket.width && stars[i].x+stars[i].size>rocket.x &&
            stars[i].y<rocket.y+rocket.height && stars[i].y+stars[i].size>rocket.y){
            stars.splice(i,1);
            score++; scoreElement.innerText="Очки: "+score;
        }
        else if (stars[i].y>canvas.height) stars.splice(i,1);
    }

    // Метеоры
    for (let i=meteors.length-1;i>=0;i--){
        meteors[i].y += meteors[i].speed;
        if (meteors[i].x < rocket.x + rocket.width && meteors[i].x+meteors[i].size>rocket.x &&
            meteors[i].y<rocket.y+rocket.height && meteors[i].y+meteors[i].size>rocket.y){
            endGame();
        }
        else if (meteors[i].y>canvas.height) meteors.splice(i,1);
    }
}

// Отрисовка (очень простой пример)
function draw() {
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle="red"; ctx.fillRect(rocket.x,rocket.y,rocket.width,rocket.height);
    ctx.fillStyle="yellow";
    stars.forEach(s=>ctx.fillRect(s.x,s.y,s.size,s.size));
    ctx.fillStyle="gray";
    meteors.forEach(m=>ctx.fillRect(m.x,m.y,m.size,m.size));
}

function gameLoop() {
    if (gameOver) return;
    update(); draw();
    requestAnimationFrame(gameLoop);
}

// Начало игры
function startGame() {
    rocket = { x: 180, y: 500, width: 40, height: 60 };
    stars = []; meteors = []; score=0; gameOver=false;
    scoreElement.innerText="Очки: 0";
    requestAnimationFrame(gameLoop);
}

// Завершение игры
function endGame() {
    gameOver = true;

    // Отправка очков на сервер
    fetch("https://your-server.com/score",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({
            score: score,
            userId: tg.initDataUnsafe.user.id,
            chatId: tg.initDataUnsafe.chat?.id,
            messageId: tg.initDataUnsafe.start_param
        })
    }).then(res=>res.json()).then(data=>{
        console.log(data.ok ? "Результат отправлен!" : "Ошибка при отправке");
    }).catch(err=>console.error(err));

    tg.showPopup({
        title:"Игра окончена",
        message:`Вы набрали ${score} очков!`,
        buttons:[{type:"default", text:"Начать снова"}]
    }, ()=>startGame());
}

// Генерация объектов каждые 500 мс
setInterval(()=>{if(!gameOver) spawnObject()},500);

startGame();
</script>
</body>
</html>
