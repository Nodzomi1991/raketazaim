<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Rocket Game</title>
<style>
  body { margin:0; overflow:hidden; background:black; }
  #gameCanvas { display:block; margin:auto; }
  #score { position:absolute; top:20px; left:20px; color:white; font-size:20px; }
  #leaderboard {
    position:absolute; top:50px; right:20px;
    color:white; background:rgba(0,0,0,0.5); padding:10px;
    font-size:16px; max-width:150px;
  }
  #leaderboard ul { padding-left:20px; margin:0; }
</style>
</head>
<body>
<canvas id="gameCanvas" width="400" height="600"></canvas>
<div id="score">–û—á–∫–∏: 0</div>
<div id="leaderboard">
  üèÜ –¢–æ–ø 5:
  <ul id="topList"></ul>
</div>

<script>
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
const scoreElement = document.getElementById("score");
const topList = document.getElementById("topList");

// Telegram WebApp
const tg = window.Telegram.WebApp;
tg.ready();

let rocket, stars, meteors, score, gameOver;

// ------------------ –ö–ª–∞—Å—Å—ã ------------------
class Rocket {
    constructor() { this.x = 180; this.y = 500; this.width = 40; this.height = 60; }
    draw() { ctx.fillStyle="red"; ctx.fillRect(this.x,this.y,this.width,this.height); }
}

class Star {
    constructor() { this.x = Math.random()*(canvas.width-30); this.y=0; this.size=20+Math.random()*20; }
    update() { this.y+=4; }
    draw() { ctx.fillStyle="yellow"; ctx.fillRect(this.x,this.y,this.size,this.size); }
    collides() { return this.x<rocket.x+rocket.width && this.x+this.size>rocket.x &&
                     this.y<rocket.y+rocket.height && this.y+this.size>rocket.y; }
}

class Meteor {
    constructor() { this.x = Math.random()*(canvas.width-30); this.y=0; this.size=20+Math.random()*20; this.speed=3+Math.random()*3; }
    update() { this.y+=this.speed; }
    draw() { ctx.fillStyle="gray"; ctx.fillRect(this.x,this.y,this.size,this.size); }
    collides() { return this.x<rocket.x+rocket.width && this.x+this.size>rocket.x &&
                     this.y<rocket.y+rocket.height && this.y+this.size>rocket.y; }
}

// ------------------ –ò–≥—Ä–∞ ------------------
function spawnObjects() {
    if(Math.random()>0.5) stars.push(new Star());
    else meteors.push(new Meteor());
}

function update() {
    if(gameOver) return;

    stars.forEach((s,i)=>{ s.update(); if(s.collides()){ stars.splice(i,1); score++; scoreElement.innerText="–û—á–∫–∏: "+score; } if(s.y>canvas.height) stars.splice(i,1); });
    meteors.forEach((m,i)=>{ m.update(); if(m.collides()) endGame(); if(m.y>canvas.height) meteors.splice(i,1); });
}

function draw() {
    ctx.clearRect(0,0,canvas.width,canvas.height);
    rocket.draw();
    stars.forEach(s=>s.draw());
    meteors.forEach(m=>m.draw());
}

function gameLoop() {
    if(gameOver) return;
    update(); draw();
    requestAnimationFrame(gameLoop);
}

function startGame() {
    rocket = new Rocket();
    stars = [];
    meteors = [];
    score = 0;
    gameOver = false;
    scoreElement.innerText="–û—á–∫–∏: 0";
    requestAnimationFrame(gameLoop);
}

// ------------------ –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—á–∫–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä ------------------
async function sendScore() {
    try{
        await fetch("https://your-server.com/score",{
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body: JSON.stringify({
                score: score,
                userId: tg.initDataUnsafe.user.id,
                chatId: tg.initDataUnsafe.chat?.id,
                messageId: tg.initDataUnsafe.start_param
            })
        });
    }catch(e){ console.error(e); }
}

// ------------------ –ö–æ–Ω–µ—Ü –∏–≥—Ä—ã ------------------
function endGame() {
    gameOver = true;
    sendScore();
    tg.showPopup({ title:"–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞", message:`–í—ã –Ω–∞–±—Ä–∞–ª–∏ ${score} –æ—á–∫–æ–≤!`,
        buttons:[{type:"default", text:"–ù–∞—á–∞—Ç—å —Å–Ω–æ–≤–∞"}]}, ()=>startGame());
}

// ------------------ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –ª–∏–¥–µ—Ä–æ–≤ ------------------
async function updateLeaderboard(){
    if(!tg.initDataUnsafe.user.id) return;
    try{
        const res = await fetch(`https://your-server.com/top5?userId=${tg.initDataUnsafe.user.id}&chatId=${tg.initDataUnsafe.chat?.id}&messageId=${tg.initDataUnsafe.start_param}`);
        const data = await res.json();
        if(data.ok){
            topList.innerHTML="";
            data.top5.forEach((p,i)=>{
                const li = document.createElement("li");
                li.textContent=`${i+1}. ${p.name} ‚Äî ${p.score}`;
                topList.appendChild(li);
            });
        }
    }catch(e){ console.error(e); }
}

// ------------------ –¢–∞–π–º–µ—Ä—ã ------------------
setInterval(()=>{if(!gameOver) spawnObjects()},500);
setInterval(()=>{updateLeaderboard()},5000);

// ------------------ –°—Ç–∞—Ä—Ç ------------------
startGame();
</script>
</body>
</html>
